<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/theme.css" />
    <link rel="shortcut icon" href="./img/favicon.ico" />
    <title>Recipes | Ben Ronkin</title>
  </head>
  <body class="dark-mode">
    <div class="wrapper">
      <nav></nav>
      <main>
        <div class="container">
          <div id="message">Fetching data from server...</div>
          <div id="login-container" class="card translucent hidden" style="margin-top: 30px; align-items: flex-start">
            <h4>Enter your email address to gain access</h4>
            <form id="login-form" class="form-horizontal">
              <div class="input-icon-group">
                <i class="fa-solid fa-envelope"></i>
                <input type="email" name="email" placeholder="Email" value="" />
              </div>
              <button id="login-btn" class="primary" type="submit">Submit</button>
            </form>
            <span id="login-message" style="margin-top: 10px; font-size: 90%"></span>
          </div>
        </div>
      </main>
      <footer></footer>
    </div>
    <script type="module">
      import { populateNav } from './partials/nav.js'
      import { populateFooter } from './partials/footer.js'
      import { handleTokenQueryParam, getWebApp, postWebApp } from './js/io.js'
      import { setMessage } from './js/ui.js'
      import { state } from './js/state.js'

      // ----------------------
      // Globals
      // ----------------------

      const loginContainer = document.querySelector('#login-container')
      const loginForm = document.querySelector('#login-form')
      const loginBtn = document.querySelector('#login-btn')
      const loginMessageEl = document.querySelector('#login-message')

      // ----------------------
      // Event listeners
      // ----------------------

      /* When page is loaded */
      document.addEventListener('DOMContentLoaded', async () => {
        handleDOMContentLoaded()
      })

      /* When login form is submitted */
      loginForm.addEventListener('submit', handleLoginFormSubmit)

      // ------------------------
      // Event handler functions
      // ------------------------

      /**
       * Handle DOMContentLoaded
       */
      async function handleDOMContentLoaded() {
        handleTokenQueryParam()

        const token = localStorage.getItem('authToken')
        if (!token) {
          setMessage('<i class="fa-solid fa-circle-exclamation"></i> Authentication failed')
          console.log('handleDOMContentLoaded: no token')
          loginContainer.classList.remove('hidden')
          populateNav({ title: 'Recipes', disableRightDrawer: true })
          populateFooter()
          return
        }

        const mode = localStorage.getItem('mode')
        if (mode === 'shopping') {
          window.location.href = './shopping/index.html'
        } else {
          window.location.href = './recipes/index.html'
        }
      }

      /**
       * Handle login form submit
       */
      async function handleLoginFormSubmit(e) {
        e.preventDefault()
        loginBtn.disabled = true
        loginMessageEl.textContent = 'Checking. Please wait...'

        const formData = new FormData(loginForm)
        const email = formData.get('email')
        try {
          const { error, message } = await postWebApp(`${state.getWebAppUrl()}/email-submit`, {
            email,
          })
          if (error) {
            throw new Error(error)
          }
          loginMessageEl.textContent = message
        } catch (err) {
          loginMessageEl.textContent = err.message
          loginBtn.disabled = false
          console.log(err)
        }
      }
    </script>
  </body>
</html>
