<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/theme.css" />
    <link rel="shortcut icon" href="./img/favicon.ico" />
    <title>Recipes | Ben Ronkin</title>
  </head>
  <body class="u-dark-mode">
    <div class="wrapper">
      <main>
        <div class="container">
          <div id="message">Fetching data from server...</div>
          <div
            id="login-container"
            class="card translucent hidden"
            style="margin-top: 30px; align-items: flex-start"
          >
            <h4>Enter your email address to gain access</h4>
          </div>
        </div>
      </main>
    </div>
    <script type="module">
      import { createNav } from './partials/nav.js'
      import { createFormHorizontal } from './partials/formHorizontal.js'
      import { createFooter } from './partials/footer.js'
      import {
        handleTokenQueryParam,
        getWebApp,
        postWebAppJson,
      } from './js/io.js'
      import { setMessage } from './js/ui.js'
      import { state } from './js/state.js'

      // ----------------------
      // Globals
      // ----------------------

      const loginContainer = document.querySelector('#login-container')
      let loginForm
      let loginButton

      // ----------------------
      // Event listeners
      // ----------------------

      /* When page is loaded */
      document.addEventListener('DOMContentLoaded', async () => {
        handleDOMContentLoaded()
      })

      // ------------------------
      // Event handler functions
      // ------------------------

      /**
       * Handle DOMContentLoaded
       */
      async function handleDOMContentLoaded() {
        // force login (temporary for setting token in db)
        const urlParams = new URLSearchParams(window.location.search)
        const setupParam = urlParams.get('setup')
        if (setupParam) {
          showLoginForm('Upgrading the app. We need your email again')
          return
        }

        handleTokenQueryParam()

        const token = localStorage.getItem('authToken')
        if (!token) {
          console.log('handleDOMContentLoaded: no token')
          showLoginForm(
            '<i class="fa-solid fa-circle-exclamation"></i> Authentication failed'
          )
          return
        }

        const mode = state.getDefaultPage()
        switch (mode) {
          case 'admin':
            window.location.href = './admin/index.html'
            break
          case 'journal':
            window.location.href = './journal/index.html'
            break
          case 'recipes':
            window.location.href = './recipes/index.html'
            break
          case 'shopping':
            window.location.href = './shopping/index.html'
            break
          case 'tasks':
            window.location.href = './tasks/index.html'
            break
          default:
            window.location.href = './recipes/index.html'
            break
        }
      }

      /**
       *
       */
      function showLoginForm(message) {
        if (message) {
          setMessage(message)
        }

        loginForm = createFormHorizontal({
          formId: 'login-form',
          inputType: 'email',
          inputName: 'email',
          inputPlaceholder: 'Email',
          iClass: 'fa-envelope',
          inputAutoComplete: false,
          submitText: 'Submit',
          events: { submit: handleLoginFormSubmit },
        })
        loginContainer.appendChild(loginForm)
        loginButton = loginForm.querySelector('button')

        loginContainer.classList.remove('hidden')
        const wrapperEl = document.querySelector('.wrapper')
        const navEl = createNav({
          title: 'The Everything App',
          disableRightDrawer: true,
        })
        wrapperEl.prepend(navEl)
        const footerEl = createFooter()
        wrapperEl.appendChild(footerEl)
      }

      /**
       * Handle login form submit
       */
      async function handleLoginFormSubmit(e) {
        e.preventDefault()
        loginForm.disable()
        loginForm.message = 'Checking. Please wait...'
        setMessage('')

        const email = loginForm.value
        try {
          const { error, message } = await postWebAppJson(
            `${state.getWebAppUrl()}/email-submit`,
            {
              email,
            }
          )
          if (error) {
            throw new Error(error)
          }
          loginForm.message = ''
          setMessage(message)
        } catch (err) {
          loginForm.message = err.message
          console.log(err)
        }
        loginForm.enable()
      }
    </script>
  </body>
</html>
